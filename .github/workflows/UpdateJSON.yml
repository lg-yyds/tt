name: Update Spider in JSON Files

on:
  schedule:
    - cron: "0 0 * * *"  # æ¯å¤©åˆå¤œ UTC è¿è¡Œ
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è¿è¡Œ

jobs:
  update-json:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Update JSON files
        run: |
          # ç¡®ä¿ JN/lem.json å­˜åœ¨
          if [ ! -f JN/lem.json ]; then
            echo "âŒ JN/lem.json æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡æ›´æ–°ã€‚"
            exit 0
          fi
          
          # ä½¿ç”¨ jq è§£æ spider å€¼ï¼Œé¿å… grep æå–ä¸å®Œæ•´æ•°æ®
          SPIDER_VALUE=$(jq -r '.spider' JN/lem.json 2>/dev/null)

          # è®°å½• spider å€¼æ—¥å¿—
          echo "Extracted spider value: $SPIDER_VALUE"
          
          # å¦‚æœ spider å€¼ä¸ºç©ºæˆ– JSON è§£æå¤±è´¥ï¼Œåˆ™è·³è¿‡æ›´æ–°
          if [ -z "$SPIDER_VALUE" ] || [ "$SPIDER_VALUE" = "null" ]; then
            echo "âŒ è§£æå¤±è´¥æˆ– spider ä¸ºç©ºï¼Œè·³è¿‡æ›´æ–°"
            exit 0
          fi
          
          # ç¡®ä¿ tv.json å’Œ tvy.json å­˜åœ¨ï¼Œå¦åˆ™åˆ›å»º
          if [ ! -f JN/tv.json ]; then
            echo '{"spider": ""}' > JN/tv.json
          fi
          if [ ! -f JN/tvy.json ]; then
            echo '{"spider": ""}' > JN/tvy.json
          fi
          
          # ä½¿ç”¨ jq å®‰å…¨æ›´æ–° JSON
          jq --arg spider "$SPIDER_VALUE" 'if type == "object" then .spider = $spider else . end' JN/tv.json > JN/tv_tmp.json && mv JN/tv_tmp.json JN/tv.json
          jq --arg spider "$SPIDER_VALUE" 'if type == "object" then .spider = $spider else . end' JN/tvy.json > JN/tvy_tmp.json && mv JN/tvy_tmp.json JN/tvy.json
          
          # ç¡®ä¿æ›´æ”¹è¢«ä¿å­˜
          echo "âœ… æˆåŠŸæ›´æ–° JN/tv.json å’Œ JN/tvy.json"
          cat JN/tv.json || echo "âš ï¸ tv.json æ–‡ä»¶ä¸å­˜åœ¨"
          cat JN/tvy.json || echo "âš ï¸ tvy.json æ–‡ä»¶ä¸å­˜åœ¨"
      
      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add JN/tv.json JN/tvy.json

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´ï¼Œé¿å…ç©ºæäº¤
          if git diff --cached --quiet; then
            echo "ğŸš« æ²¡æœ‰å˜åŒ–ï¼Œä¸æäº¤"
            exit 0
          fi

          git commit -m "Update spider value in tv.json and tvy.json"
          git push
