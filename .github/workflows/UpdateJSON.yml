name: Update Spider in JSON Files

on:
  schedule:
    - cron: "0 0 * * *"  # 每天午夜 UTC 运行
  workflow_dispatch:  # 允许手动运行

jobs:
  update-json:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Update JSON files
        run: |
          # 确保 JN/lem.json 存在
          if [ ! -f JN/lem.json ]; then
            echo "❌ JN/lem.json 文件不存在，跳过更新。"
            exit 0
          fi
          
          # 使用 jq 解析 spider 值，避免 grep 提取不完整数据
          SPIDER_VALUE=$(jq -r '.spider' JN/lem.json 2>/dev/null)

          # 记录 spider 值日志
          echo "Extracted spider value: $SPIDER_VALUE"
          
          # 如果 spider 值为空或 JSON 解析失败，则跳过更新
          if [ -z "$SPIDER_VALUE" ] || [ "$SPIDER_VALUE" = "null" ]; then
            echo "❌ 解析失败或 spider 为空，跳过更新"
            exit 0
          fi
          
          # 确保 tv.json 和 tvy.json 存在，否则创建
          if [ ! -f JN/tv.json ]; then
            echo '{"spider": ""}' > JN/tv.json
          fi
          if [ ! -f JN/tvy.json ]; then
            echo '{"spider": ""}' > JN/tvy.json
          fi
          
          # 使用 jq 安全更新 JSON
          jq --arg spider "$SPIDER_VALUE" 'if type == "object" then .spider = $spider else . end' JN/tv.json > JN/tv_tmp.json && mv JN/tv_tmp.json JN/tv.json
          jq --arg spider "$SPIDER_VALUE" 'if type == "object" then .spider = $spider else . end' JN/tvy.json > JN/tvy_tmp.json && mv JN/tvy_tmp.json JN/tvy.json
          
          # 确保更改被保存
          echo "✅ 成功更新 JN/tv.json 和 JN/tvy.json"
          cat JN/tv.json || echo "⚠️ tv.json 文件不存在"
          cat JN/tvy.json || echo "⚠️ tvy.json 文件不存在"
      
      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add JN/tv.json JN/tvy.json

          # 检查是否有变更，避免空提交
          if git diff --cached --quiet; then
            echo "🚫 没有变化，不提交"
            exit 0
          fi

          git commit -m "Update spider value in tv.json and tvy.json"
          git push
